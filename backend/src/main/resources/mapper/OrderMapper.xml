<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.smartorder.mapper.OrderMapper">
    <resultMap id="OrderWithMerchantMap" type="com.smartorder.entity.Order">
        <id property="id" column="id"/>
        <result property="orderNo" column="order_no"/>
        <result property="merchantId" column="merchant_id"/>
        <result property="merchantName" column="merchant_name"/>
        <result property="userId" column="user_id"/>
        <result property="orderType" column="order_type"/>
        <result property="tableNo" column="table_no"/>
        <result property="addressId" column="address_id"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="status" column="status"/>
        <result property="payStatus" column="pay_status"/>
        <result property="remark" column="remark"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="deleted" column="deleted"/>
    </resultMap>

    <select id="getOrdersWithMerchantName" resultMap="OrderWithMerchantMap">
        SELECT 
            o.*,
            m.name as merchant_name
        FROM t_order o
        LEFT JOIN t_merchant m ON o.merchant_id = m.id
        WHERE o.deleted = 0
        <if test="userId != null">
            AND o.user_id = #{userId}
        </if>
        <if test="merchantId != null">
            AND o.merchant_id = #{merchantId}
        </if>
        <if test="status != null">
            AND o.status = #{status}
        </if>
        ORDER BY o.created_at DESC
    </select>

    <select id="getMerchantUserOrdersWithMerchantName" resultMap="OrderWithMerchantMap">
        SELECT 
            o.*,
            m.name as merchant_name
        FROM t_order o
        LEFT JOIN t_merchant m ON o.merchant_id = m.id
        WHERE o.deleted = 0
        AND o.merchant_user_id = #{merchantUserId}
        <if test="status != null">
            AND o.status = #{status}
        </if>
        ORDER BY o.updated_at DESC
    </select>

    <select id="getOrderByIdWithMerchantName" resultMap="OrderWithMerchantMap">
        SELECT 
            o.*,
            m.name as merchant_name
        FROM t_order o
        LEFT JOIN t_merchant m ON o.merchant_id = m.id
        WHERE o.id = #{id}
          AND o.deleted = 0
    </select>

    <select id="getSalesStatistics" resultType="java.util.HashMap">
        SELECT 
            COUNT(*) as totalOrders,
            COALESCE(SUM(total_amount), 0) as totalAmount,
            SUM(CASE WHEN DATE_FORMAT(created_at, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m') THEN 1 ELSE 0 END) as monthOrders,
            COALESCE(SUM(CASE WHEN DATE_FORMAT(created_at, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m') THEN total_amount ELSE 0 END), 0) as monthAmount,
            SUM(CASE WHEN DATE(created_at) = CURDATE() THEN 1 ELSE 0 END) as todayOrders,
            COALESCE(SUM(CASE WHEN DATE(created_at) = CURDATE() THEN total_amount ELSE 0 END), 0) as todayAmount
        FROM t_order
        WHERE merchant_id = #{merchantId}
          AND deleted = 0
          AND pay_status = 1
    </select>
</mapper>
